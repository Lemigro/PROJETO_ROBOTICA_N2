[
    {
        "id": "http-in-robo-data",
        "type": "http in",
        "z": "flow1",
        "name": "Receber Dados Robô",
        "url": "/robo-data",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 100,
        "wires": [["function-process", "debug-raw"]]
    },
    {
        "id": "function-process",
        "type": "function",
        "z": "flow1",
        "name": "Processar Dados",
        "func": "const msgType = msg.payload.type;\nconst data = msg.payload.data;\nconst timestamp = msg.payload.timestamp || new Date().toISOString();\n\nif (msgType === 'metrics') {\n    node.send({\n        topic: 'metrics',\n        payload: {\n            ...data,\n            timestamp: timestamp\n        }\n    });\n} else if (msgType === 'trajectory') {\n    node.send({\n        topic: 'trajectory',\n        payload: {\n            ...data,\n            timestamp: timestamp\n        }\n    });\n} else if (msgType === 'execution_summary') {\n    node.send({\n        topic: 'summary',\n        payload: {\n            ...data,\n            timestamp: timestamp\n        }\n    });\n}\n\nreturn null;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 320,
        "y": 100,
        "wires": [["switch-type"]]
    },
    {
        "id": "switch-type",
        "type": "switch",
        "z": "flow1",
        "name": "Separar por Tipo",
        "property": "topic",
        "propertyType": "msg",
        "rules": [
            {"t": "eq", "v": "metrics", "vt": "str"},
            {"t": "eq", "v": "trajectory", "vt": "str"},
            {"t": "eq", "v": "summary", "vt": "str"}
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 520,
        "y": 100,
        "wires": [
            ["function-split-metrics"],
            ["function-trajectory", "file-trajectory", "debug-trajectory"],
            ["debug-summary", "file-summary", "function-comparative"]
        ]
    },
    {
        "id": "function-split-metrics",
        "type": "function",
        "z": "flow1",
        "name": "Separar Métricas",
        "func": "// Extrai valores individuais para cada gauge\nconst data = msg.payload;\nconst now = Date.now();\n\n// Arredonda valores para exibição (limita casas decimais)\nconst coverage = Math.round((data.coverage_percentage || 0) * 100) / 100; // 2 casas decimais\nconst efficiency = Math.round((data.efficiency || 0) * 100) / 100; // 2 casas decimais\nconst energy = Math.round((data.total_energy || 0) * 10) / 10; // 1 casa decimal\nconst time = Math.round((data.total_time || 0) * 10) / 10; // 1 casa decimal\n\n// Envia valores separados para cada gauge (arredondados)\nnode.send([\n    {payload: coverage, topic: 'coverage'},\n    {payload: efficiency, topic: 'efficiency'},\n    {payload: energy, topic: 'energy'},\n    // Para line chart: envia objetos separados com topic como série (valores originais para gráfico)\n    {payload: data.coverage_percentage || 0, topic: 'Cobertura'},\n    {payload: data.total_time || 0, topic: 'Tempo'},\n    {payload: data, topic: 'file'}\n]);\n\nreturn null;",
        "outputs": 6,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 100,
        "wires": [
            ["gauge-coverage"],
            ["gauge-efficiency"],
            ["gauge-energy"],
            ["chart-time"],
            ["chart-time"],
            ["file-metrics"]
        ]
    },
    {
        "id": "gauge-coverage",
        "type": "ui_gauge",
        "z": "flow1",
        "name": "Cobertura",
        "group": "dashboard-group",
        "order": 1,
        "width": 0,
        "height": 0,
        "gtype": "gauge",
        "title": "Cobertura (%)",
        "label": "percentual",
        "format": "{{value | number:2}}%",
        "min": 0,
        "max": 100,
        "colors": ["#00b500", "#e6e600", "#ca3838"],
        "seg1": "50",
        "seg2": "80",
        "x": 970,
        "y": 60,
        "wires": []
    },
    {
        "id": "gauge-efficiency",
        "type": "ui_gauge",
        "z": "flow1",
        "name": "Eficiência",
        "group": "dashboard-group",
        "order": 2,
        "width": 0,
        "height": 0,
        "gtype": "gauge",
        "title": "Eficiência",
        "label": "%/J",
        "format": "{{value | number:2}}",
        "min": 0,
        "max": 2,
        "colors": ["#00b500", "#e6e600", "#ca3838"],
        "seg1": "0.5",
        "seg2": "1.0",
        "x": 970,
        "y": 140,
        "wires": []
    },
    {
        "id": "gauge-energy",
        "type": "ui_gauge",
        "z": "flow1",
        "name": "Energia",
        "group": "dashboard-group",
        "order": 3,
        "width": 0,
        "height": 0,
        "gtype": "gauge",
        "title": "Energia Consumida",
        "label": "Joules",
        "format": "{{value | number:1}}J",
        "min": 0,
        "max": 1000,
        "colors": ["#00b500", "#e6e600", "#ca3838"],
        "seg1": "300",
        "seg2": "600",
        "x": 970,
        "y": 220,
        "wires": []
    },
    {
        "id": "chart-time",
        "type": "ui_chart",
        "z": "flow1",
        "name": "Evolução",
        "group": "dashboard-group",
        "order": 4,
        "width": 0,
        "height": 0,
        "label": "Evolução Tempo vs Cobertura",
        "chartType": "line",
        "legend": "true",
        "xformat": "HH:mm:ss",
        "interpolate": "linear",
        "nodata": "",
        "dot": false,
        "ymin": "",
        "ymax": "",
        "removeOlder": 1,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": ["#1f77b4", "#ff7f0e"],
        "useOldStyle": false,
        "outputs": 1,
        "x": 970,
        "y": 300,
        "wires": [[]]
    },
    {
        "id": "function-trajectory",
        "type": "function",
        "z": "flow1",
        "name": "Formatar Trajetória",
        "func": "// Formata trajetória para scatter chart\nconst data = msg.payload;\n\nif (!data || typeof data.x !== 'number' || typeof data.y !== 'number') {\n    return null;\n}\n\n// Para scatter chart, o formato deve ser simples: objeto com x e y\n// SEM topic, pois pode causar problemas\nconst xVal = parseFloat(data.x.toFixed(3));\nconst yVal = parseFloat(data.y.toFixed(3));\n\n// Formato correto para scatter: objeto simples {x, y}\nmsg.payload = {\n    x: xVal,\n    y: yVal\n};\n\n// Remove topic para evitar problemas\nmsg.topic = '';\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 180,
        "wires": [["chart-trajectory-2d", "debug-trajectory-formatted"]]
    },
    {
        "id": "chart-trajectory-2d",
        "type": "ui_chart",
        "z": "flow1",
        "name": "Trajetória 2D",
        "group": "dashboard-group",
        "order": 5,
        "width": 0,
        "height": 0,
        "label": "Trajetória do Robô (Vista Superior)",
        "chartType": "scatter",
        "legend": "false",
        "xformat": "auto",
        "interpolate": "linear",
        "nodata": "Aguardando dados de trajetória...",
        "dot": true,
        "ymin": "",
        "ymax": "",
        "removeOlder": 0,
        "removeOlderPoints": "",
        "removeOlderUnit": "3600",
        "cutout": 0,
        "useOneColor": false,
        "colors": ["#1f77b4"],
        "useOldStyle": false,
        "outputs": 1,
        "x": 970,
        "y": 180,
        "wires": [[]]
    },
    {
        "id": "function-comparative",
        "type": "function",
        "z": "flow1",
        "name": "Preparar Comparativo",
        "func": "const summary = msg.payload;\n\n// Debug: verifica estrutura\nif (!summary) {\n    node.warn('Comparativo: dados vazios');\n    return null;\n}\n\nconst execNum = summary.execution_number || 1;\n\nlet history = global.get('execution_history') || [];\n\nhistory.push({\n    execution: execNum,\n    coverage: summary.coverage_percentage || 0,\n    time: summary.total_time || 0,\n    energy: summary.total_energy || 0,\n    efficiency: summary.efficiency || 0,\n    timestamp: summary.timestamp || new Date().toISOString()\n});\n\nif (history.length > 10) {\n    history = history.slice(-10);\n}\n\nglobal.set('execution_history', history);\n\n// Envia dados para o chart - formato correto para line chart com múltiplas séries\n// Para line chart, cada mensagem precisa ter um valor numérico e um topic\n// O chart agrupa automaticamente por topic\nconst msgs = [];\nhistory.forEach((h, index) => {\n    // Envia cada série separadamente\n    // O chart usa o topic para identificar a série\n    msgs.push({payload: h.coverage, topic: 'Cobertura'});\n    msgs.push({payload: h.time, topic: 'Tempo'});\n    msgs.push({payload: h.efficiency, topic: 'Eficiência'});\n});\n\nnode.warn('Comparativo: enviando ' + msgs.length + ' mensagens para ' + history.length + ' execuções');\n\nreturn msgs;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 260,
        "wires": [["chart-comparative"]]
    },
    {
        "id": "chart-comparative",
        "type": "ui_chart",
        "z": "flow1",
        "name": "Comparativo",
        "group": "dashboard-group",
        "order": 6,
        "width": 0,
        "height": 0,
        "label": "Comparativo Entre Execuções",
        "chartType": "line",
        "legend": "true",
        "xformat": "auto",
        "interpolate": "linear",
        "nodata": "Execute pelo menos 2 vezes para ver comparação",
        "dot": true,
        "ymin": "",
        "ymax": "",
        "removeOlder": 0,
        "removeOlderPoints": "",
        "removeOlderUnit": "86400",
        "cutout": 0,
        "useOneColor": false,
        "colors": ["#1f77b4", "#ff7f0e", "#2ca02c"],
        "useOldStyle": false,
        "outputs": 1,
        "x": 970,
        "y": 260,
        "wires": [[]]
    },
    {
        "id": "file-metrics",
        "type": "file",
        "z": "flow1",
        "name": "Salvar Métricas",
        "filename": "C:\\temp\\node-red-robot-metrics.json",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 970,
        "y": 340,
        "wires": []
    },
    {
        "id": "file-trajectory",
        "type": "file",
        "z": "flow1",
        "name": "Salvar Trajetória",
        "filename": "C:\\temp\\node-red-robot-trajectory.json",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 970,
        "y": 420,
        "wires": []
    },
    {
        "id": "file-summary",
        "type": "file",
        "z": "flow1",
        "name": "Salvar Resumo",
        "filename": "C:\\temp\\node-red-robot-summary.json",
        "appendNewline": true,
        "createDir": true,
        "overwriteFile": "false",
        "encoding": "utf8",
        "x": 970,
        "y": 500,
        "wires": []
    },
    {
        "id": "debug-raw",
        "type": "debug",
        "z": "flow1",
        "name": "Dados Brutos",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 320,
        "y": 200,
        "wires": []
    },
    {
        "id": "debug-summary",
        "type": "debug",
        "z": "flow1",
        "name": "Resumo",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 580,
        "wires": []
    },
    {
        "id": "debug-trajectory",
        "type": "debug",
        "z": "flow1",
        "name": "Trajetória Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 750,
        "y": 240,
        "wires": []
    },
    {
        "id": "debug-trajectory-formatted",
        "type": "debug",
        "z": "flow1",
        "name": "Trajetória Formatada",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 970,
        "y": 240,
        "wires": []
    },
    {
        "id": "dashboard-group",
        "type": "ui_group",
        "z": "",
        "name": "Robô Aspirador",
        "tab": "dashboard-tab",
        "order": 1,
        "disp": true,
        "width": "12",
        "height": "1",
        "collapse": false
    },
    {
        "id": "dashboard-tab",
        "type": "ui_tab",
        "z": "",
        "name": "Dashboard Robô",
        "icon": "dashboard",
        "order": 1,
        "disabled": false,
        "hidden": false
    }
]

